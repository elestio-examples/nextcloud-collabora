version: '2'
services:

  #nextcloud-db:
  #  image: postgres:12-alpine
  #  container_name: nextcloud-db
  #  restart: unless-stopped
  #  environment:
  #    POSTGRES_USER: nextcloud
  #    POSTGRES_PASSWORD: password
  #  volumes:
  #    - nextcloud-db:/var/lib/postgresql/data
  #    - /etc/localtime:/etc/localtime:ro

  nextcloud-db:
    image: mariadb:latest
    restart: always
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
    volumes:
      - ./nextcloud-db:/var/lib/mysql

  nextcloud-cache:
    image: redis:alpine
    restart: always
    mem_limit: 2048m
    mem_reservation: 512m
    command: redis-server --requirepass password

  nextcloud-app:
    image: nextcloud:fpm-alpine
    restart: always
    ports:
      - 172.17.0.1:21000:80
    depends_on:
      - nextcloud-db
      - nextcloud-cache
    environment:
    #   MYSQL_DATABASE: nextcloud
    #   MYSQL_USER: nextcloud
    #   MYSQL_PASSWORD: password
    #   MYSQL_HOST: nextcloud-db
      POSTGRES_DB: nextcloud
      POSTGRES_USER: nextcloud
      POSTGRES_PASSWORD: password
      POSTGRES_HOST: nextcloud-db
      NEXTCLOUD_ADMIN_USER: admin
      NEXTCLOUD_ADMIN_PASSWORD: password
      NEXTCLOUD_TRUSTED_DOMAINS: ${DOMAIN}
      REDIS_HOST: nextcloud-cache
      REDIS_HOST_PASSWORD: password
      SMTP_HOST: ${EMAIL_HOST}
      SMTP_SECURE: tls
      SMTP_PORT: ${EMAIL_PORT}
      SMTP_AUTHTYPE: LOGIN
      SMTP_NAME: ${MAIL_FROM_ADDRESS}@${MAIL_DOMAIN}
      SMTP_PASSWORD: ""
      MAIL_FROM_ADDRESS: no-reply
      MAIL_DOMAIN: ${MAIL_DOMAIN}
    volumes:
      - ./nextcloud-app:/var/www/html

#   nextcloud-web:
#     image: nginx:alpine
#     restart: always
#     volumes:
#       - ./nginx.conf:/etc/nginx/nginx.conf:ro
#     volumes_from:
#       - nextcloud-app

  nextcloud-collabora:
    image: collabora/code
    restart: always
    ports:
      - 172.17.0.1:21002:9980
    depends_on:
      - nextcloud-app
    cap_add:
     - MKNOD
    environment:
      - username=admin
      - password=password
      - DONT_GEN_SSL_CERT=yes
      - server_name=${DOMAIN}
      - dictionaries=en_US es_ES pt_BR
      - extra_params=--o:ssl.enable=false
      # Domain the service should be accessed from:
     #- domain=${VIRTUAL_HOST}
     #- domain=example.com
      #
     #- VIRTUAL_HOST=${COLLABORA_VIRTUAL_HOST}
     #- VIRTUAL_HOST=collabra.example.com
     #- LETSENCRYPT_HOST=${COLLABORA_VIRTUAL_HOST}
     #- LETSENCRYPT_HOST=${COLLABORA_VIRTUAL_HOST}
      #
      # Extra parameters to Collabora, see also
      # https://www.collaboraoffice.com/code/nginx-reverse-proxy/:
      # SSL terminates at the proxy
     #- extra_params=--o:ssl.enable=false --o:ssl.termination=true
    volumes:
      - /etc/localtime:/etc/localtime:ro