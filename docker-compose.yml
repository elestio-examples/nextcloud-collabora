version: "3.4"

services:

    redis:
        image: redis:latest
        restart: always

    db:
        image: postgres:12-alpine
        restart: always
        environment:
            POSTGRES_USER: nextcloud
            POSTGRES_PASSWORD: password
        volumes:
            - ./nextcloud-db:/var/lib/postgresql/data
            - /etc/localtime:/etc/localtime:ro

    # db:
    #     image: mariadb:latest
    #     #user: "1000:1000"
    #     command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    #     restart: always
    #     volumes:
    #       - ./db:/var/lib/mysql
    #     environment:
    #       - MYSQL_ROOT_PASSWORD=${ADMIN_PASSWORD}
    #       - MYSQL_PASSWORD=nextcloud
    #       - MYSQL_DATABASE=nextcloud_db
    #       - MYSQL_USER=nextcloud

    nextcloud: 
        depends_on: 
          - redis
          - db
        image: nextcloud:latest
        restart: always
        environment: 
            - REDIS_HOST=redis
            - REDIS_HOST_PORT=6379
            # - MYSQL_PASSWORD=nextcloud
            # - MYSQL_DATABASE=nextcloud_db
            # - MYSQL_USER=nextcloud
            - POSTGRES_DB=nextcloud
            - POSTGRES_USER=nextcloud
            - POSTGRES_PASSWORD=password
            - NEXTCLOUD_ADMIN_USER=${ADMIN_LOGIN}
            - NEXTCLOUD_ADMIN_PASSWORD=${ADMIN_PASSWORD}
            - NEXTCLOUD_TRUSTED_DOMAINS=${DOMAIN}
            - SMTP_HOST=172.17.0.1
            - SMTP_PORT=25
            - SMTP_AUTHTYPE=PLAIN
            - MAIL_FROM_ADDRESS=[DOMAIN]@vm.elestio.app
            - PHP_MEMORY_LIMIT=512M
            - PHP_UPLOAD_LIMIT=512M
            - OVERWRITEPROTOCOL=https
        ports:
            - 172.17.0.1:21000:80
        volumes: 
            - "./nextcloud/data:/var/www/html/data"
            - "./nextcloud/config:/var/www/html/config"
            - "./nextcloud/themes:/var/www/html/themes"
            - "./nextcloud/custom_apps:/var/www/html/custom_apps"
            - "/etc/localtime:/etc/localtime:ro"


    collabora:
        image: collabora/code:latest
        cap_add: 
            - MKNOD
        environment: 
            - domain=${DOMAIN}
            - username=root
            - password=${ADMIN_PASSWORD}
            - 'extra_params=--o:ssl.enable=false --o:ssl.termination=true--restart'
        ports:
            - 172.17.0.1:21002:9980
        restart: always
        volumes:
            - "/etc/localtime:/etc/localtime:ro"
